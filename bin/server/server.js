(()=>{"use strict";var e={14:(e,t)=>{var i;Object.defineProperty(t,"__esModule",{value:!0}),t.ServerClientOperate=void 0,function(e){e.ADD="ADD",e.DELETE="DELETE",e.FULL="FULL",e.HEARTBEAT="HEARTBEAT",e.REFRESH="REFRESH",e.ERROR="ERROR"}(i||(t.ServerClientOperate=i={}))},21:function(e,t,i){var s=this&&this.__createBinding||(Object.create?function(e,t,i,s){void 0===s&&(s=i);var r=Object.getOwnPropertyDescriptor(t,i);r&&!("get"in r?!t.__esModule:r.writable||r.configurable)||(r={enumerable:!0,get:function(){return t[i]}}),Object.defineProperty(e,s,r)}:function(e,t,i,s){void 0===s&&(s=i),e[s]=t[i]}),r=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var i in e)"default"!==i&&Object.prototype.hasOwnProperty.call(e,i)&&s(t,e,i);return r(t,e),t},n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.Utils=void 0;const o=i(317),l=n(i(896)),c=a(i(857)),h=n(i(928));t.Utils=class{static getLocalIP(){const e=c.networkInterfaces(),t=["Virtual","VMware","vEthernet"];for(let i in e){if(t.some((e=>i.includes(e))))continue;let s=e[i];for(let e=0;e<s.length;e++){let t=s[e];if("IPv4"===t.family&&"127.0.0.1"!==t.address&&!t.internal)return t.address}}return console.warn("无法获取本机IP地址，将使用默认地址"),"127.0.0.1"}static checkDirExist(e){l.default.existsSync(e)||l.default.mkdirSync(e)}static getRelativePath(e,t=""){return process.pkg?h.default.join(process.cwd(),e.substring(1)):h.default.join(__dirname,t,e)}static openBrowser(e){switch(process.platform){case"win32":(0,o.exec)(`start ${e}`);break;case"darwin":(0,o.exec)(`open ${e}`);break;default:(0,o.exec)(`xdg-open ${e}`)}}static decodeMimeEncodedString(e){const t=/=\?([^?]+)\?([BQ])\?([^?]+)\?=/i.exec(e);if(!t)return e;const i=t[1],s=t[2].toUpperCase(),r=t[3];let a;return a="B"===s?Buffer.from(r,"base64").toString(i):"Q"===s?r.replace(/_/g," ").replace(/=([A-Fa-f0-9]{2})/g,((e,t)=>String.fromCharCode(parseInt(t,16)))):e,a}}},86:e=>{e.exports=require("ws")},174:e=>{e.exports=require("compression")},252:e=>{e.exports=require("express")},278:e=>{e.exports=require("net")},317:e=>{e.exports=require("child_process")},322:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.Pool=void 0,t.Pool=class{constructor(e){this.createObject=e,this.pool=[]}forEach(e){this.pool.forEach(e)}get(){return this.pool.length>0?(this.pool=this.pool.reverse(),this.pool.pop()):this.createObject()}recycle(e){this.pool.push(e)}}},367:function(e,t,i){var s=this&&this.__awaiter||function(e,t,i,s){return new(i||(i=Promise))((function(r,a){function n(e){try{l(s.next(e))}catch(e){a(e)}}function o(e){try{l(s.throw(e))}catch(e){a(e)}}function l(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(n,o)}l((s=s.apply(e,t||[])).next())}))},r=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.FileOperation=void 0;const a=r(i(896)),n=i(21);t.FileOperation=class{static deleteFile(e){return s(this,void 0,void 0,(function*(){(e=n.Utils.getRelativePath(e))&&a.default.existsSync(e)?a.default.unlink(e,(e=>{e&&console.log("删除文件失败"+e)})):console.log("文件不存在"+e)}))}}},418:function(e,t,i){var s=this&&this.__awaiter||function(e,t,i,s){return new(i||(i=Promise))((function(r,a){function n(e){try{l(s.next(e))}catch(e){a(e)}}function o(e){try{l(s.throw(e))}catch(e){a(e)}}function l(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(n,o)}l((s=s.apply(e,t||[])).next())}))},r=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.DatabaseOperation=void 0;const a=r(i(896)),n=r(i(689)),o=i(975),l=i(834),c=i(21);class h{static openDatabase(e,t){return s(this,void 0,void 0,(function*(){if(this.dbIsOpen)return Promise.resolve();this.dbPath=c.Utils.getRelativePath(e),this.dbExists=a.default.existsSync(this.dbPath),yield new Promise(((e,i)=>{this.tableName=t,this.db=new n.default.Database(this.dbPath,(t=>{t?i(t):e(this.createTable())}))}))}))}static createTable(){return s(this,void 0,void 0,(function*(){let e=this;yield new Promise(((t,i)=>{e.db.run(e.getSqlCommand(l.SQLCAMMAND.CREATETABLE),(s=>{s?(e.db.close(),i(s)):(e.dbIsOpen=!0,e.dbExists?(console.log("数据库已开启："),console.log(this.dbPath),t(null)):t(e.writeToDatabase(o.ServerConfig.welcomeMsg)))}))}))}))}static writeToDatabase(e){return this.dbIsOpen?new Promise(((t,i)=>{const{fileName:s,fileOrTextHash:r,timestamp:a,text:n,msgType:o,url:c,size:h,hashName:p}=e;this.db.run(this.getSqlCommand(l.SQLCAMMAND.WRITETODATABASE),[s,r,a,n,o,c,h,p],(e=>{e?i(e):t()}))})):Promise.resolve()}static deleteFromDatabase(e){return this.dbIsOpen?new Promise(((t,i)=>{this.db.run(this.getSqlCommand(l.SQLCAMMAND.DELETEFROMDATABASE),e,(e=>{e?i(e):t()}))})):Promise.resolve()}static getAllMsgs(){return this.dbIsOpen?new Promise(((e,t)=>{this.db.all(this.getSqlCommand(l.SQLCAMMAND.GETALLMSGS),((i,s)=>{i?t(i):e(s)}))})):Promise.resolve([])}static getAllFileOrTextHashes(){return this.dbIsOpen?new Promise(((e,t)=>{this.db.all(this.getSqlCommand(l.SQLCAMMAND.GETALLFILEORTEXTHASHES),[],((i,s)=>{if(i)t(i);else{const t=s.map((e=>e.fileOrTextHash));e(t)}}))})):Promise.resolve([])}static getFileHashAndFileNameMap(){return this.dbIsOpen?new Promise(((e,t)=>{this.db.all(this.getSqlCommand(l.SQLCAMMAND.GETALLFILEHASHES),[],((i,s)=>{if(i)t(i);else{const t=new Map;for(const e of s)t.set(e.fileOrTextHash,e.fileName);e(t)}}))})):Promise.resolve(new Map)}static getMsgDataByHash(e){return this.dbIsOpen?new Promise(((t,i)=>{this.db.get(this.getSqlCommand(l.SQLCAMMAND.GETMSGTYPEBYHASH),e,((e,s)=>{e?i(e):t(s)}))})):Promise.resolve({})}static getFileName2HashNameMap(){return this.dbIsOpen?new Promise(((e,t)=>{this.db.all(this.getSqlCommand(l.SQLCAMMAND.GETFILENAME2HASHNAMEMAP),((i,s)=>{if(i)t(i);else{const t=new Map;for(const e of s)t.set(e.fileName,e.originalname);e(t)}}))})):Promise.resolve(new Map)}static getSqlCommand(e,t){switch(t=t||this.tableName,e){case l.SQLCAMMAND.CREATETABLE:return`CREATE TABLE IF NOT EXISTS ${t} (fileName TEXT, fileOrTextHash TEXT, timestamp INTEGER, text TEXT, msgType TEXT,url TEXT,size INTEGER,originalname TEXT)`;case l.SQLCAMMAND.WRITETODATABASE:return`INSERT INTO ${t} (fileName, fileOrTextHash, timestamp, text, msgType, url ,size,originalname) VALUES (?, ?, ?, ?, ? ,? ,?,?)`;case l.SQLCAMMAND.DELETEFROMDATABASE:return`DELETE FROM ${t} WHERE fileOrTextHash = ?`;case l.SQLCAMMAND.GETALLMSGS:return`SELECT * FROM ${t}`;case l.SQLCAMMAND.GETALLFILEORTEXTHASHES:return`SELECT fileOrTextHash FROM ${t}`;case l.SQLCAMMAND.GETMSGTYPEBYHASH:return`SELECT * FROM ${t} WHERE fileOrTextHash = ?`;case l.SQLCAMMAND.GETFILENAME2HASHNAMEMAP:return`SELECT fileName, originalname FROM ${t} WHERE msgType = 'file'`;case l.SQLCAMMAND.GETALLFILEHASHES:return`SELECT * FROM ${t} WHERE msgType = 'file'`;default:return""}}}t.DatabaseOperation=h,h.tableName="",h.dbIsOpen=!1,h.dbExists=!1},461:e=>{e.exports=require("multer")},474:(e,t,i)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.Handler=void 0;const s=i(322);class r{constructor(){this._isOnce=!0,this._isRecover=!0}static createHandler(e,t,i=!0){let s=this.getHandler();return s=this.setHandler(e,t,s,i),s}static getHandler(){let e=this.pool.get();return e._isRecover=!1,e}static setHandler(e,t,i,s=!0){return i._caller=e,i._callback=t,i._isOnce=s,i}static recoverHandler(e){e&&e instanceof r&&0==e.isRecover&&(e._reset(),this.pool.recycle(e))}_reset(){this._caller=null,this._callback=null,this._isOnce=!0,this._isRecover=!0}get isOnce(){return this._isOnce}get isRecover(){return this._isRecover}run(){var e;this._isRecover||(null===(e=this._callback)||void 0===e||e.call(this._caller),this._isOnce&&r.recoverHandler(this))}runWith(e){var t;this._isRecover||(null===(t=this._callback)||void 0===t||t.apply(this._caller,e),this._isOnce&&r.recoverHandler(this))}isMe(e,t){return this._caller==e&&this._callback==t}isCaller(e){return this._caller==e}}t.Handler=r,r.pool=new s.Pool((()=>new r))},553:function(e,t,i){var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.ServerConfigMgr=void 0;const r=s(i(896)),a=i(975),n=i(21);t.ServerConfigMgr=class{static readConfig(e){if(e=n.Utils.getRelativePath(e),r.default.existsSync(e))try{let t=JSON.parse(r.default.readFileSync(e,"utf-8"));a.ServerConfig.httpPort=t.httpPort,a.ServerConfig.socketPort=t.socketPort,a.ServerConfig.serverIp=t.serverIp,console.log("配置文件读取成功")}catch(e){console.warn(e)}else console.warn("未找到配置文件，将使用默认配置")}static writeConfig(e){e=n.Utils.getRelativePath(e),r.default.writeFileSync(e,JSON.stringify(a.ServerConfig.serverConfig,null,2))}}},611:e=>{e.exports=require("http")},689:e=>{e.exports=require("sqlite3")},738:(e,t,i)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.EventMgr=void 0;const s=i(474);class r{static on(e,t,i){let r;this.eventMap.has(e)||this.eventMap.set(e,[]),r=this.eventMap.get(e);let a=s.Handler.createHandler(i,t,!1);r.push(a),this.eventMap.set(e,r)}static once(e,t,i){let r;this.eventMap.has(e)||this.eventMap.set(e,[]),r=this.eventMap.get(e);let a=s.Handler.createHandler(i,t,!0);r.push(a),this.eventMap.set(e,r)}static off(e,t,i){if(this.eventMap.has(e)){let r=this.eventMap.get(e);for(let e=0;e<r.length;e++){let a=r[e];a.isMe(i,t)&&(r.splice(e,1),e--,s.Handler.recoverHandler(a))}}}static offAll(e){this.eventMap.forEach(((t,i)=>{for(let i=0;i<t.length;i++){let r=t[i];r.isCaller(e)&&(t.splice(i,1),i--,s.Handler.recoverHandler(r))}}))}static offAllEvent(e){if(this.eventMap.has(e)){let t=this.eventMap.get(e);for(let e=0;e<t.length;e++){let i=t[e];s.Handler.recoverHandler(i)}this.eventMap.delete(e)}}static offAllEvents(){this.eventMap.forEach(((e,t)=>{for(let t=0;t<e.length;t++){let i=e[t];s.Handler.recoverHandler(i)}})),this.eventMap.clear()}static emit(e,...t){if(this.eventMap.has(e)){let i=this.eventMap.get(e);for(let e=0;e<i.length;e++){let r=i[e];r.runWith(t),r.isOnce&&(i.splice(e,1),e--,s.Handler.recoverHandler(r))}}}}t.EventMgr=r,r.eventMap=new Map},834:(e,t)=>{var i,s;Object.defineProperty(t,"__esModule",{value:!0}),t.EventName=t.SQLCAMMAND=void 0,function(e){e[e.CREATETABLE=0]="CREATETABLE",e[e.WRITETODATABASE=1]="WRITETODATABASE",e[e.DELETEFROMDATABASE=2]="DELETEFROMDATABASE",e[e.GETALLMSGS=3]="GETALLMSGS",e[e.GETALLFILEORTEXTHASHES=4]="GETALLFILEORTEXTHASHES",e[e.GETMSGTYPEBYHASH=5]="GETMSGTYPEBYHASH",e[e.GETFILENAME2HASHNAMEMAP=6]="GETFILENAME2HASHNAMEMAP",e[e.GETALLFILEHASHES=7]="GETALLFILEHASHES"}(i||(t.SQLCAMMAND=i={})),function(e){e.ONMESSAGESAVED="ONMESSAGESAVED",e.DELETEITEM="DELETEITEM"}(s||(t.EventName=s={}))},848:function(e,t,i){var s=this&&this.__awaiter||function(e,t,i,s){return new(i||(i=Promise))((function(r,a){function n(e){try{l(s.next(e))}catch(e){a(e)}}function o(e){try{l(s.throw(e))}catch(e){a(e)}}function l(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(n,o)}l((s=s.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const r=i(418),a=i(905),n=i(975),o=i(553),l=i(932),c=i(21);class h{constructor(){this.init()}init(){return s(this,void 0,void 0,(function*(){n.ServerConfig.serverIp=c.Utils.getLocalIP(),o.ServerConfigMgr.readConfig(n.ServerConfig.serverConfigPath),yield r.DatabaseOperation.openDatabase(n.ServerConfig.sqlDbPath,n.ServerConfig.tableName),yield l.SocketServer.startServer(n.ServerConfig.socketPort),yield a.HttpServer.startServer(n.ServerConfig.httpPort),yield o.ServerConfigMgr.writeConfig(n.ServerConfig.serverConfigPath),c.Utils.openBrowser(`http://${n.ServerConfig.serverIp}:${n.ServerConfig.httpPort}`)}))}}t.default=h,new h},857:e=>{e.exports=require("os")},896:e=>{e.exports=require("fs")},905:function(e,t,i){var s=this&&this.__awaiter||function(e,t,i,s){return new(i||(i=Promise))((function(r,a){function n(e){try{l(s.next(e))}catch(e){a(e)}}function o(e){try{l(s.throw(e))}catch(e){a(e)}}function l(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(n,o)}l((s=s.apply(e,t||[])).next())}))},r=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.HttpServer=void 0;const a=r(i(174)),n=r(i(982)),o=r(i(252)),l=r(i(896)),c=r(i(611)),h=r(i(461)),p=r(i(928)),f=i(981),d=i(738),u=i(418),v=i(975),E=i(834),m=i(21);class S{static startServer(e){return s(this,void 0,void 0,(function*(){yield u.DatabaseOperation.getFileName2HashNameMap().then((e=>{this.fileName2HashNameMap=e,this.hashName2FileNameMap=new Map,this.fileName2HashNameMap&&this.fileName2HashNameMap.forEach(((e,t)=>{this.hashName2FileNameMap.set(e,t)}))})),yield u.DatabaseOperation.getFileHashAndFileNameMap().then((e=>{this.hash2FileNameMap=e})),yield new Promise(((t,i)=>{this.savePath=m.Utils.getRelativePath(v.ServerConfig.uploadFileSavePath),this.toolPath=m.Utils.getRelativePath(v.ServerConfig.toolPath),this.initServer(),t(this.startHttpServer(this.server,e))}))}))}static initServer(){m.Utils.checkDirExist(this.savePath),this.appExpress=(0,o.default)(),this.appExpress.use((0,a.default)()),this.server=c.default.createServer(this.appExpress),this.storageEngine=h.default.diskStorage({destination:(e,t,i)=>{i(null,this.savePath)},filename:(e,t,i)=>{let s=Date.now()+"-"+Math.round(1e9*Math.random());i(null,t.fieldname+"-"+s+p.default.extname(t.originalname))}}),this.uploadMulter=(0,h.default)({storage:this.storageEngine})}static startHttpServer(e,t){return s(this,void 0,void 0,(function*(){yield new Promise(((i,s)=>{e.listen(t).on("listening",(()=>{this.addEvent(),this.initHttpServerApi(),console.log("http服务器已启动："),console.log(`http://${v.ServerConfig.serverIp}:${v.ServerConfig.httpPort}`),i(null)})).on("error",(r=>{"EADDRINUSE"===r.code?(console.warn(`http服务器请求的端口${t}已被占用，尝试使用端口${t+10}`),e.removeAllListeners("listening"),e.removeAllListeners("error"),v.ServerConfig.httpPort=t+10,i(this.startHttpServer(e,t+10))):(s(r),console.error(r))}))}))}))}static addEvent(){d.EventMgr.on(E.EventName.DELETEITEM,this.deleteFileOrText,this)}static removeEvent(){d.EventMgr.off(E.EventName.DELETEITEM,this.deleteFileOrText,this)}static deleteFileOrText(e){if(this.hash2FileNameMap&&this.hash2FileNameMap.delete(e),this.fileName2HashNameMap){let t=this.hashName2FileNameMap.get(e);t&&this.fileName2HashNameMap.delete(t),this.hashName2FileNameMap.delete(e)}}static initHttpServerApi(){this.initUploadApi(),this.initGetSocketInfoApi(),this.initGetWebFileApi(),this.initGetUploadFileApi(),this.initGetToolApi()}static initUploadApi(){this.appExpress.post("/upload",this.uploadMulter.single("file"),((e,t,i)=>{if(!e.file&&!e.body.text)return i(new Error("文件为空"));this.onFileUpload(e,t,i),this.onTextUpload(e,t,i)}),((e,t,i,s)=>{i.status(500).send(e.message)}))}static onFileUpload(e,t,i){if(e.file){let i=this;const s=n.default.createHash("md5"),r=l.default.createReadStream(e.file.path);r.on("data",(e=>s.update(e))),r.on("end",(()=>{const r=s.digest("hex");if(e.file.originalname=Buffer.from(e.file.originalname,"latin1").toString("utf8"),this.hash2FileNameMap.get(r)){let e=i.hash2FileNameMap.get(r);if(!t.headersSent)return t.status(409).send("文件已存在："+e)}let a=`${v.ServerConfig.uploadFileSavePath}/${e.file.filename}`;const n={msgType:"file",fileOrTextHash:r,timestamp:Date.now(),fileName:m.Utils.decodeMimeEncodedString(e.file.originalname),url:a,size:e.file.size/1024>0?e.file.size/1024:0,hashName:e.file.filename};u.DatabaseOperation.writeToDatabase(n).then((()=>{t.headersSent||t.send("文件上传成功"),d.EventMgr.emit(E.EventName.ONMESSAGESAVED,n),this.hash2FileNameMap.set(r,e.file.originalname),this.fileName2HashNameMap.set(e.file.originalname,e.file.filename),this.hashName2FileNameMap.set(e.file.filename,e.file.originalname)})).catch((e=>{console.error(e),t.headersSent||t.status(500).send("数据库写入失败")}))}))}}static onTextUpload(e,t,i){if(e.body.text){const i=e.body.text;let s={msgType:"text",fileOrTextHash:n.default.createHash("md5").update(i+Date.now()+"-"+Math.round(1e9*Math.random())).digest("hex"),timestamp:Date.now(),text:i,size:0,hashName:""};u.DatabaseOperation.writeToDatabase(s).then((()=>{d.EventMgr.emit(E.EventName.ONMESSAGESAVED,s),t.headersSent||t.send("已发送")})).catch((e=>{console.error(e),t.headersSent||t.status(500).send("数据库写入失败")}))}}static initGetSocketInfoApi(){this.appExpress.get("/getSocketInfo",((e,t)=>{const i={socketServerURL:v.ServerConfig.serverIp,socketPort:v.ServerConfig.socketPort,projectName:f.ProjectConfig.projectName,author:f.ProjectConfig.author,description:f.ProjectConfig.description,version:f.ProjectConfig.versionStr};t.send(i)}))}static initGetWebFileApi(){for(let e in v.ServerConfig.httpFileMap)this.appExpress.get(e,((t,i)=>{const s=p.default.join(__dirname,"../client/"+v.ServerConfig.httpFileMap[e]);i.sendFile(s,(t=>{if(t){let t=`File not found1: ${v.ServerConfig.httpFileMap[e]}`;console.log(t),i.headersSent||i.status(404).send(t)}}))}));this.appExpress.get("/:file",((e,t)=>{const i=p.default.join(__dirname,"../client/",e.params.file);t.sendFile(i,(i=>{if(i){let i=`File not found: ${e.params.file}`;console.log(i),t.headersSent||t.status(404).send(i)}}))}))}static initGetUploadFileApi(){let e=this;this.appExpress.get("/uploadFile/:filename",((t,i)=>{const s=`${e.savePath}/${t.params.filename}`,r=e.hashName2FileNameMap.get(t.params.filename);i.download(s,r,(e=>{e&&(console.error(e),i.headersSent||i.status(500).send("文件下载失败"))}))}))}static initGetToolApi(){this.appExpress.get("/tool/:filename",((e,t)=>{t.download(p.default.join(__dirname,"../tool/"+e.params.filename),e.params.filename,(e=>{e&&(console.error(e),t.headersSent||t.status(500).send("工具下载失败"))}))}))}}t.HttpServer=S,S.savePath="",S.toolPath=""},928:e=>{e.exports=require("path")},932:function(e,t,i){var s=this&&this.__createBinding||(Object.create?function(e,t,i,s){void 0===s&&(s=i);var r=Object.getOwnPropertyDescriptor(t,i);r&&!("get"in r?!t.__esModule:r.writable||r.configurable)||(r={enumerable:!0,get:function(){return t[i]}}),Object.defineProperty(e,s,r)}:function(e,t,i,s){void 0===s&&(s=i),e[s]=t[i]}),r=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var i in e)"default"!==i&&Object.prototype.hasOwnProperty.call(e,i)&&s(t,e,i);return r(t,e),t},n=this&&this.__awaiter||function(e,t,i,s){return new(i||(i=Promise))((function(r,a){function n(e){try{l(s.next(e))}catch(e){a(e)}}function o(e){try{l(s.throw(e))}catch(e){a(e)}}function l(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(n,o)}l((s=s.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.SocketServer=void 0;const o=a(i(278)),l=i(86),c=i(14),h=i(738),p=i(418),f=i(367),d=i(975),u=i(834);class v{static startServer(e){return n(this,void 0,void 0,(function*(){yield new Promise(((t,i)=>{this.server=o.createServer(),this.server.once("error",(i=>{"EADDRINUSE"===i.code?(console.log(`端口${e}已被占用，尝试使用端口${e+10}`),t(v.startServer(e+10))):console.error(i)})),this.server.once("listening",this.initSocketServer.bind(this,e,t)),this.server.listen(e)}))}))}static closeSocketServer(){var e;if(this.removeEvent(),this.wss)for(let e of this.wss.clients)e.off("close",this.onWsClose.bind(this)),e.off("message",this.onWsMsg.bind(this,e)),e.off("error",this.onWsError.bind(this)),e.close();null===(e=this.wss)||void 0===e||e.close()}static initSocketServer(e,t){var i;if(null===(i=this.server)||void 0===i||i.close(),this.server=null,!e||"number"!=typeof e)throw new Error("端口号必须是数字");this.wss=new l.WebSocketServer({port:e}),d.ServerConfig.socketPort=e,this._lastMsgChangeTimestamp=Date.now(),this.addEvent(),t(),console.log("socket服务器已启动："),console.log(`ws://${d.ServerConfig.serverIp}:${e}`)}static addEvent(){this.wss.on("connection",this.onSocketConnection.bind(this)),h.EventMgr.on(u.EventName.ONMESSAGESAVED,this.onMessageSaved,this)}static removeEvent(){var e;null===(e=this.wss)||void 0===e||e.off("connection",this.onSocketConnection),h.EventMgr.off(u.EventName.ONMESSAGESAVED,this.onMessageSaved,this)}static onMessageSaved(e){let t={msg:e};this._lastMsgChangeTimestamp=Date.now();let i={operate:c.ServerClientOperate.ADD,timeStamp:this._lastMsgChangeTimestamp,data:t},s=JSON.stringify(i);this.wss.clients.forEach((e=>{e.send(s)}))}static onSocketConnection(e){e.on("close",this.onWsClose.bind(this)),e.on("message",this.onWsMsg.bind(this,e)),e.on("error",this.onWsError.bind(this))}static onWsClose(){}static onWsError(e){console.warn(e)}static onWsMsg(e,t){let i=JSON.parse(t);switch(i.operate){case c.ServerClientOperate.HEARTBEAT:let t={operate:c.ServerClientOperate.HEARTBEAT,timeStamp:this._lastMsgChangeTimestamp};e.send(JSON.stringify(t));break;case c.ServerClientOperate.DELETE:let s=i.data.fileOrTextHash;p.DatabaseOperation.getMsgDataByHash(s).then((e=>{null!=e&&null!=e.msgType&&("file"===e.msgType&&f.FileOperation.deleteFile(e.url),p.DatabaseOperation.deleteFromDatabase(s).then((()=>{h.EventMgr.emit(u.EventName.DELETEITEM,s),this._lastMsgChangeTimestamp=Date.now();let e={fileOrTextHash:s},t={operate:c.ServerClientOperate.DELETE,timeStamp:this._lastMsgChangeTimestamp,data:e},i=JSON.stringify(t);this.wss.clients.forEach((e=>{e.send(i)}))})))}));break;case c.ServerClientOperate.FULL:p.DatabaseOperation.getAllMsgs().then((t=>{let i={msgs:t},s={operate:c.ServerClientOperate.FULL,timeStamp:this._lastMsgChangeTimestamp,data:i};e.send(JSON.stringify(s))}));break;case c.ServerClientOperate.REFRESH:let r={operate:c.ServerClientOperate.REFRESH,timeStamp:this._lastMsgChangeTimestamp};e.send(JSON.stringify(r));break;default:let a={error:"未知的operate:"+i.operate},n={operate:c.ServerClientOperate.ERROR,timeStamp:this._lastMsgChangeTimestamp,data:a};e.send(JSON.stringify(n))}}}t.SocketServer=v,v._lastMsgChangeTimestamp=0},975:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.ServerConfig=void 0;class i{static get serverConfig(){return{ps1:"此处为端口以及IP配置，默认http服务器4100，socket服务器4200",ps2:"如果你要修改，请修改下面的端口号之后重启服务器",ps3:"如果端口冲突，默认+10直到找到空闲端口",ps4:"如果IP获取不对，请修改下面的IP地址",httpPort:this.httpPort,socketPort:this.socketPort,serverIp:this.serverIp}}static get welcomeMsg(){return{msgType:"text",fileOrTextHash:"850f3be40c4b93f7dd0910942d1e5a23",timestamp:Date.now(),text:"是信息，好耶！<copyright by NoRain>",size:0}}}t.ServerConfig=i,i.serverIp="127.0.0.1",i.httpPort=4100,i.socketPort=4200,i.uploadFileSavePath="../uploadFile",i.toolPath="../tool",i.sqlDbPath="../fsDatabase.sqlite",i.tableName="fsTable",i.httpFileMap={"/":"index.html"},i.serverConfigPath="../serverConfig.json"},981:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.ProjectConfig=void 0;class i{}t.ProjectConfig=i,i.projectName="fileSync",i.author="NoRain",i.versionStr="5.4.4",i.description="一个简单的文件/文字同步服务器",i.closeLog=!1,i.maxMsgLen=64,i.removeMsgLen=20,i.sendTimeout=100,i.jokeAPI="https://v2.jokeapi.dev/joke/Any"},982:e=>{e.exports=require("crypto")}},t={};!function i(s){var r=t[s];if(void 0!==r)return r.exports;var a=t[s]={exports:{}};return e[s].call(a.exports,a,a.exports,i),a.exports}(848)})();